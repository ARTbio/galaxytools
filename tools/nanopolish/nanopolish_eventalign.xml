<tool id="nanopolish_eventalign" name="Nanopolish eventalign" version="0.1.0">
    <description>- Align nanopore events to reference k-mers </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        ln -s '$input_merged' reads.fasta && 
        
        #if $input_reads_raw.extension == 'fast5':
            mkdir fast5_files && ln -s '$input_reads_raw' fast5_files/read1.fast5 &&
        #else
            ln -s '$input_reads_raw' fast5_files.tar.gz &&
            mkdir fast5_files && tar -xzf fast5_files.tar.gz -C fast5_files &&
        #end if

        nanopolish index -d fast5_files/ reads.fasta &&
        ln -s '$input_reads_bam' reads.bam &&
        ln -s '${input_reads_bam.metadata.bam_index}' reads.bam.bai &&
        ln -s '$input_genome_fa' genome.fa &&
        
        nanopolish eventalign
        -r reads.fasta
        -b reads.bam
        -g genome.fa
        $samples
        $scale_events
        $SAM
        $print_read_names
        #if $window and str($window).strip():
          -w "${window}"
        #end if        
        #if $adv.input_models_fofn:
          --models-fofn '$input_models_fofn'
        #end if
        #if $summary:
            --summary eventalign-summary.txt
        #end if
        > eventalign.out


    ]]></command>
    <inputs>
      <!-- index inputs -->
        <param type="data" name="input_merged" format="fasta,fastq" label="Basecalled merged reads.fa"/>
        <param type="data" name="input_reads_raw" format="h5,fast5.tar.gz" label="Flat archive file of raw fast5 files"/>

        <!-- variants consensus inputs -->
        <param type="data" name="input_reads_bam" format="bam" label="Reads aligned to the reference genome" help="(-b)" />
        <param type="data" name="input_genome_fa" format="fasta" label="The reference genome" help="(-g)"/>

        <section name="adv" title="Optional data inputs">
            <!-- optional inputs -->
            <param type="data" name="input_models_fofn" format="txt" optional="true" label="Read alternative k-mer models" help="(--models-fofn)" />
        </section>

        <!-- optional params -->
        <param name="window" type="text" optional="true" label="find variants in window chromsome:start-end" help="(-w)"/>

        <!-- optional flags -->
        <param name="summary" type="boolean" truevalue="--summary" falsevalue="" checked="true" label="Summarize the alignment of each read/strand" help="(--summary)" />
        <param name="samples" type="boolean" truevalue="--samples" falsevalue="" checked="false" label="Write the raw samples for the event to the tsv output" help="(--samples)" />
        <param name="scale_events" type="boolean" truevalue="--scale-events" falsevalue="" checked="false" label="Scale events to the model, rather than vice-versa" help="(--scale-events)" />
        <param name="SAM" type="boolean" truevalue="--sam" falsevalue="" checked="false" label="write output in SAM format" help="(--sam)" />
        <param name="print_read_names" type="boolean" truevalue="--print-read-names" falsevalue="" checked="false" label="Print read names instead of indexes" help="(--print-read-names)" />

    </inputs>

    <outputs>
      <!-- variants consensus outputs -->
        <data name="output_summary" format="txt" from_work_dir="eventalign-summary.txt" label="eventalign summary of reads/strands" />
        <data name="output_eventalign" format="txt" from_work_dir="eventalign.out" label="Computed variants"/>
    </outputs>
    <tests>
        <test>
      <!-- index test -->
            <param name="input_merged" ftype="fasta" value="reads.fasta" />
            <param name="input_reads_raw" ftype="fast5.tar.gz" value="fast5_files.tar.gz" />
            
      <!-- variants consensus test -->
            <param name="input_reads_bam" value="reads.sorted.bam" />
            <param name="input_genome_fa" value="draft.fa" />
            <param name="window" value="tig00000001:200000-200010" />
            <param name="SAM" value="true" />

            <output name="output_summary" file="eventalign-summary.txt" />
            <output name="output_eventalign" file="reads-draft.eventalign.sam"/>
        </test>
    </tests>
    <help><![CDATA[
        Usage: nanopolish eventalign [OPTIONS] --reads reads.fa --bam alignments.bam --genome genome.fa
        Align nanopore events to reference k-mers

        Tutorial and manual available at:
        http://nanopolish.readthedocs.io/en/latest/quickstart_eventalign.html      
        
        ]]></help>
    <expand macro="citations" />
</tool>
