<tool id="sklearn_build_pipeline" name="Pipeline Builder" version="@VERSION@">
    <description>constructs a list of transforms and a final estimator</description>
    <macros>
        <import>main_macros.xml</import>
    </macros>
    <expand macro="python_requirements"/>
    <expand macro="macro_stdio"/>
    <version_command>echo "@VERSION@"</version_command>
    <command>
        <![CDATA[
        python "$sklearn_pipeline_script" '$inputs'
        ]]>
    </command>
    <configfiles>
        <inputs name="inputs" />
        <configfile name="sklearn_pipeline_script">
            <![CDATA[
import sys
import json
import pickle
import xgboost
import sklearn
import ast
import sklearn.model_selection
from sklearn import svm, linear_model, ensemble, preprocessing, naive_bayes, tree, neighbors
from sklearn.pipeline import Pipeline

@GET_ESTIMATOR_FUNCTION_NEW@
@FEATURE_SELECTOR_FUNCTION@

input_json_path = sys.argv[1]
with open(input_json_path, "r") as param_handler:
    params = json.load(param_handler)

pipeline_steps = []

# Set up pre_processor and add to pipeline steps.
if params['pre_processing']['do_pre_processing'] == 'Yes':
    preprocessor = params["pre_processing"]["pre_processors"]["selected_pre_processor"]
    pre_processor_options = params["pre_processing"]["pre_processors"]["options"]
    my_class = getattr(preprocessing, preprocessor)
    pipeline_steps.append( ('pre_processor', my_class(**pre_processor_options)) )

# Set up feature selector and add to pipeline steps.
if params['feature_selection']['do_feature_selection'] == 'Yes':
    feature_selector = feature_selector(params['feature_selection']['feature_selection_algorithms'])
    pipeline_steps.append( ('feature_selector', feature_selector) )

# Set up estimator and add to pipeline.
estimator_json = params["final_estimator"]['estimator_selector']
estimator = get_estimator(estimator_json)

pipeline_steps.append( ('estimator', estimator) )

pipeline = Pipeline(pipeline_steps)

with open("$outfile", 'wb') as out_handler:
    pickle.dump(pipeline, out_handler, pickle.HIGHEST_PROTOCOL)

            ]]>
        </configfile>
    </configfiles>
    <inputs>
        <conditional name="pre_processing">
            <param name="do_pre_processing" type="select" label="Do pre_processing?">
                <option value="No" selected="true"/>
                <option value="Yes"/>
            </param>
            <when value="No"/>
            <when value="Yes">
                <conditional name="pre_processors">
                    <expand macro="sparse_preprocessors_ext" />
                    <expand macro="sparse_preprocessor_options_ext" />
                </conditional>
            </when>
        </conditional>
        <conditional name="feature_selection">
            <param name="do_feature_selection" type="select" label="Do feature selection?">
                <option value="No" selected="true"/>
                <option value="Yes"/>
            </param>
            <when value="No"/>
            <when value="Yes">
                <expand macro="feature_selection_all"/>
            </when>
        </conditional>
        <section name="final_estimator" title="Final Estimator" expanded="true">
            <expand macro="estimator_selector_all" />
        </section>
    </inputs>
    <outputs>
        <data format="zip" name="outfile"/>
    </outputs>
    <tests>
        <test>
            <param name="do_pre_processing" value="Yes"/>
            <param name="selected_pre_processor" value="RobustScaler"/>
            <param name="do_feature_selection" value="Yes"/>
            <param name="selected_algorithm" value="SelectKBest"/>
            <param name="score_func" value="f_classif"/>
            <param name="selected_module" value="svm"/>
            <param name="selected_estimator" value="SVR"/>
            <param name="estimator_params" value="{'kernel': &quot;linear&quot;}"/>
            <output name="outfile" file="pipeline01" compare="sim_size" delta="500"/>
        </test>
        <test>
            <param name="do_pre_processing" value="Yes"/>
            <param name="selected_pre_processor" value="RobustScaler"/>
            <param name="selected_module" value="linear_model"/>
            <param name="selected_estimator" value="LassoCV"/>
            <output name="outfile" file="pipeline02" compare="sim_size" delta="500"/>
        </test>
        <test>
            <param name="do_pre_processing" value="Yes"/>
            <param name="selected_pre_processor" value="RobustScaler"/>
            <param name="selected_module" value="xgboost"/>
            <param name="selected_estimator" value="XGBClassifier"/>
            <output name="outfile" file="pipeline03" compare="sim_size" delta="500"/>
        </test>
    </tests>
    <help>
        <![CDATA[
**What it does**
Constructs a pipeline that contains a list of transfroms and a final estimator. Pipeline assembles several steps
that can be cross-validated together while setting different parameters.
please refer to `Scikit-learn pipeline Pipeline`_.


**New estimator** text input supports estimators from `xgboost`_ and many scikit-learn modules, including `svm`_, `linear_model`_, `ensemble`_, `naive_bayes`_, `tree`_ and `neighbors`_.
Examples are xgboost.XGBClassifier(), svm.SVR() and ensemble.RandomForestRegressor(n_estimators = 1000, random_state = 42).


.. _`Scikit-learn pipeline Pipeline`: http://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html
.. _`svm`: http://scikit-learn.org/stable/modules/classes.html#module-sklearn.svm
.. _`linear_model`: http://scikit-learn.org/stable/modules/classes.html#module-sklearn.linear_model
.. _`ensemble`: http://scikit-learn.org/stable/modules/classes.html#module-sklearn.ensemble
.. _`naive_bayes`: http://scikit-learn.org/stable/modules/classes.html#module-sklearn.naive_bayes
.. _`tree`: http://scikit-learn.org/stable/modules/classes.html#module-sklearn.tree
.. _`neighbors`: http://scikit-learn.org/stable/modules/classes.html#module-sklearn.neighbors
.. _`xgboost`: https://xgboost.readthedocs.io/en/latest/python/python_api.html

        ]]>
    </help>
    <expand macro="sklearn_citation"/>
</tool>
