<tool id="cp-measureimageintensity" name="MeasureImageIntensity" version="19.05">
  <description>module of CellProfiler v3.1.9</description>
  <requirements>
     <requirement type="package" version="2.7.16">python</requirement>
  </requirements>
  <macros>
	<import>macros.xml</import>
  </macros>
  <configfiles>
    <inputs name="inputs" filename="input.json" />
<configfile name="test">
import json
import sys


input_json_path=sys.argv[1]

as_dict = json.load(open(input_json_path, "r"))
params=json.dumps(as_dict, indent=4, sort_keys=True)

with open("output","w") as f:
  f.write(params)

f.close()  
</configfile>  
 <configfile name="script_file">
import json
import sys
import os

FOURSPACES="    "
NEWLINE="\n"

input_json_path = sys.argv[1]
input_pipeline= sys.argv[2]

params = json.load(open(input_json_path, "r"))

def writemoss():
  f.write(NEWLINE)

  f.write("MeasureImageIntensity:[module_num:"+str(new_count)+"|svn_version:\\'Unknown\\'|variable_revision_number:2|show_window:False|notes:\\x5B\\x5D|batch_state:array(\\x5B\\x5D, dtype=uint8)|enabled:True|wants_pause:False]"+NEWLINE)  


  for intensity in params['rpt_intensity']:
    obj_flag = intensity['con_intensity']['only_from_objects']
    
    f.write(FOURSPACES+"Select the image to measure:"+intensity['image_to_measure']+NEWLINE)
    f.write(FOURSPACES+"Measure the intensity only from areas enclosed by objects?:"+obj_flag+NEWLINE)
    
    if obj_flag =="No":
      f.write(FOURSPACES+"Select the input objects:None"+NEWLINE)
    else:
      f.write(FOURSPACES+"Select the input objects:"+intensity['con_intensity']['input_objects']+NEWLINE)
  
with open(input_pipeline) as fin:
  lines = fin.readlines()
  
  k,v= lines[4].strip().split(':')

  module_count = int(v)
  new_count = module_count+1
  lines[4]= k+":"+str(new_count)+"\n"
  with open("output","w") as f:
    f.writelines(lines)
    writemoss()

f.close() 
 </configfile>    
</configfiles>
  <command><![CDATA[
    python $script_file $inputs $input_pipeline
  ]]></command>
  <inputs>

      <expand macro="input_pipeline_macro" />
      <repeat name="rpt_intensity" title="Add another image">
        <param name="image_to_measure" label="Select image to measure" type="text"/>
        <conditional name="con_intensity">
          <param name="only_from_objects" label="Measure the intensity only from areas enclosed by objects?" display="radio" type="select">
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </param>

          <when value="Yes">
            <param name="input_objects" label="Select the input objects" type="text"/>
          </when>
        </conditional>
      </repeat>
  </inputs>

  <outputs>
    <expand macro="output_pipeline_macro" />
  </outputs>

  <stdio>
  	<exit_code range="1:" level="fatal" description="Error occured"/>
  </stdio>
  <tests>

  </tests>
  <help>
    This tool append the MeasureImageIntensity module section to an existing pipeline file (.cppipe).

    Input: existing pipeline file

    Output: new pipeline file

    Combine this tool with "Common" and "CellProfiler" together to run the module alone.
  </help>
</tool>

