<tool id="cp_image_math" name="ImageMath" version="0.1.0" python_template_version="3.5">
    <description>perform simple mathematical operations on image intensities in CellProfiler</description>
    <macros>
        <import>macros.xml</import>
        <xml name="select_category">
            <conditional name="category">
                <param name="category" type="select" label="Category" help="Select a measurement made on the image below. The value of the measurement is used for the operand for all of the pixels of the other operand's image.">
                    <option value="filename">FileName</option>
                    <option value="frame">Frame</option>
                    <option value="height">Height</option>
                    <option value="md5digest">MD5Digest</option>
                    <option value="pathname">PathName</option>
                    <option value="scaling">Scaling</option>
                    <option value="series">Series</option>
                    <option value="url">URL</option>
                    <option value="width">Width</option>
                </param>
                <when value="filename">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="frame">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="height">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="md5digest">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="pathname">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="scaling">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="series">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="url">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="width">
                    <param name="measurement" type="text" label="Image">
                        <expand macro="text_validator" />
                    </param>
                </when>
            </conditional>
        </xml>


        <xml name="image_without_multiplier_1">
            <conditional name="image_or_measurement">
                <param name="image_or_measurement" type="select" label="Image or measurement?" help="You can perform math operations or you can use a measurement for one of the operands.">
                    <option value="Image">Image</option>
                    <option value="Measurement">Measurement</option>
                </param>
                <when value="Image">
                    <param name="select_the_first_image" type="text" label="Enter the name the first image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="Measurement">
                    <expand macro="select_category" />
                </when>
            </conditional>
        </xml>


        <xml name="image_without_multiplier_2">
            <conditional name="image_or_measurement">
                <param name="image_or_measurement" type="select" label="Image or measurement?" help="You can perform math operations or you can use a measurement for one of the operands.">
                    <option value="Image">Image</option>
                    <option value="Measurement">Measurement</option>
                </param>
                <when value="Image">
                    <param name="select_the_second_image" type="text" label="Enter the name the second image">
                        <expand macro="text_validator" />
                    </param>
                </when>
                <when value="Measurement">
                    <expand macro="select_category" />
                </when>
            </conditional>
        </xml>


        <xml name="section_image_with_multiplier_1">
            <section name="first_image" title="First image" expanded="true">
                <expand macro="image_without_multiplier_1" />
                <param name="multiply_the_first_image_by" type="float" value="1.0" label="Enter the number that you would like to multiply the first image by"/>
            </section>
        </xml>


        <xml name="section_image_without_multiplier_1">
            <section name="first_image" title="First image" expanded="true">
                <expand macro="image_without_multiplier_1" />
            </section>
        </xml>


        <xml name="section_image_with_multiplier_2">
            <section name="second_image" title="Second image" expanded="true">
                <expand macro="image_without_multiplier_2" />
                <param name="multiply_the_second_image_by" type="float" value="1.0" label="Enter the number that you would like to multiply the second image by"/>
            </section>
        </xml>


        <xml name="section_image_without_multiplier_2">
            <section name="second_image" title="Second image" expanded="true">
                <expand macro="image_without_multiplier_2" />
            </section>
        </xml>


        <xml name="section_ops_result">
            <section name="op_results" title="Operations on the results" expanded="false">
                <param name="raise_the_power_of_the_result_by" type="float" value="1.0" label="Enter an exponent to raise the result to after the chosen operation"/>
                <param name="multiply_the_result_by" type="float" value="1.0" label="Enter the number that you would like to multiply the above image by"/>
                <param name="add_to_result" type="float" value="0.0" label="Enter a number to add to the result after the chosen operation"/>
                <param name="set_values_less_than_0_equal_to_0" type="select" display="radio" label="Set the values less than 0 equal to 0?" help="Values outside the range 0 to 1 might not be handled well by other CellProfiler tools.">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </param>
                <param name="set_values_greater_than_1_equal_to_1" type="select" display="radio" label="Set the values greater than 1 equal to 1?" help="Values outside the range 0 to 1 might not be handled well by other CellProfiler tools.">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </param>
            </section>
        </xml>
    </macros>
    <requirements>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
            python '$__tool_directory__/cp_image_math.py' -p '$input_pipeline' -i '$inputs'
            ]]>
    </command>
    <configfiles>
        <inputs name="inputs" />
    </configfiles>
    <inputs>
        <expand macro="input_pipeline_macro" />
        <param name="name_output_image" type="text" label="Enter a name for the resulting image">
            <expand macro="text_validator" />
        </param>
        <conditional name="operation">
            <param name="operation" type="select" label="Operation" help="You can select operations for single images (Invert, Log transform base 2, Log transform legacy) or between pairs of images (Add, Subtract, Absolute Difference, Multiply, Divide, Average, Minimum, Maximum). Some operations produce binary images (And, Or, Not, Equals).">
                <option value="add">Add</option>
                <option value="subtract">Subtract</option>
                <option value="multiply">Multiply</option>
                <option value="divide">Divide</option>
                <option value="average">Average</option>
                <option value="minimum">Minimum</option>
                <option value="maximum">Maximum</option>
                <option value="invert">Invert</option>
                <option value="log_2">Log transform (base 2)</option>
                <option value="log_legacy">Log transform (legacy)</option>
                <option value="and">And</option>
                <option value="or">Or</option>
                <option value="not">Not</option>
                <option value="equals">Equals</option>
            </param>
            <when value="add">
                <expand macro="section_image_with_multiplier_1" />
                <expand macro="section_image_with_multiplier_2" />
                <expand macro="section_ops_result" />
            </when>
            <when value="subtract">
                <expand macro="section_image_with_multiplier_1" />
                <expand macro="section_image_with_multiplier_2" />
                <expand macro="section_ops_result" />
            </when>
            <when value="multiply">
                <expand macro="section_image_with_multiplier_1" />
                <expand macro="section_image_with_multiplier_2" />
                <expand macro="section_ops_result" />
            </when>
            <when value="divide">
                <expand macro="section_image_with_multiplier_1" />
                <expand macro="section_image_with_multiplier_2" />
                <expand macro="section_ops_result" />
            </when>
            <when value="average">
                <expand macro="section_image_with_multiplier_1" />
                <expand macro="section_image_with_multiplier_2" />
                <expand macro="section_ops_result" />
            </when>
            <when value="minimum">
                <expand macro="section_image_with_multiplier_1" />
                <expand macro="section_image_with_multiplier_2" />
                <expand macro="section_ops_result" />
            </when>
            <when value="maximum">
                <expand macro="section_image_with_multiplier_1" />
                <expand macro="section_image_with_multiplier_2" />
                <expand macro="section_ops_result" />
            </when>
            <when value="invert">
                <param name="select_the_image" type="text" label="Select the image">
                    <expand macro="text_validator" />
                </param>
                <param name="multiply_the_image_by" type="float" value="1.0" label="Enter the number that you would like to multiply the above image by"/>
                <expand macro="section_ops_result" />
            </when>
            <when value="log_2">
                <param name="select_the_image" type="text" label="Select the image">
                    <expand macro="text_validator" />
                </param>
                <param name="multiply_the_image_by" type="float" value="1.0" label="Enter the number that you would like to multiply the above image by"/>
                <expand macro="section_ops_result" />
            </when>
            <when value="log_legacy">
                <param name="select_the_image" type="text" label="Select the image">
                    <expand macro="text_validator" />
                </param>
                <param name="multiply_the_image_by" type="float" value="1.0" label="Enter the number that you would like to multiply the above image by"/>
                <expand macro="section_ops_result" />
            </when>
            <when value="and">
                <expand macro="section_image_without_multiplier_1" />
                <expand macro="section_image_without_multiplier_2" />
            </when>
            <when value="or">
                <expand macro="section_image_without_multiplier_1" />
                <expand macro="section_image_without_multiplier_2" />
            </when>
            <when value="not">
                <expand macro="section_image_without_multiplier_1" />
            </when>
            <when value="equals">
                <expand macro="section_image_without_multiplier_1" />
                <expand macro="section_image_without_multiplier_2" />
            </when>
        </conditional>
        <param name="ignore_the_image_masks" type="select" display="radio" label="Ignore the image masks?" help="Select Yes to set equal to zero all previously masked pixels and operate on the masked images as if no mask had been applied. Otherwise, the smallest image mask is applied after image math has been completed.">
            <option value="Yes">Yes</option>
            <option value="No">No</option>
        </param>
    </inputs>
    <outputs>
        <data name="output_pipeline" from_work_dir="output.cppipe" format="txt" label="Output pipeline" />
    </outputs>
    <tests>
        <test>
            <param name="input_pipeline" value="base.cppipe" />
            <conditional name="operation">
                <param name="operation" value="add" />
            </conditional>
            <param name="name_output_image" value="ImageAfterMath" />
            <conditional name="image_or_measurement">
                <param name="image_or_measurement" value="Image" />
            </conditional>
            <param name="select_the_first_image" value="DNA"/>
            <param name="multiply_the_first_image_by" value="1.0"/>
            <param name="select_the_second_image" value="CellImage"/>
            <param name="multiply_the_second_image_by" value="2.0"/>
            <param name="raise_the_power_of_the_result_by" value="1.0"/>
            <param name="multiply_the_result_by" value="1.0"/>
            <param name="add_to_result" value="0.0"/>
            <param name="set_values_less_than_0_equal_to_0" value="Yes"/>
            <param name="set_values_greater_than_1_equal_to_1" value="Yes"/>
            <param name="ignore_the_image_masks" value="No"/>
            <output name="output_pipeline" ftype="txt" file="image_math_1.cppipe" lines_diff="0"/>
        </test>
    </tests>
    <help>
        <![CDATA[
        **What it does**

            This module can perform addition, subtraction, multiplication, division, or averaging of two or more image intensities, as well as inversion, log transform, or scaling by a constant for individual image intensities.

            Keep in mind that after the requested operations are carried out, the final image may have a substantially different range of pixel intensities than the original. CellProfiler assumes that the image is scaled from 0 – 1 for object identification and display purposes, so additional rescaling may be needed. Please see the RescaleIntensity module for more scaling options.
            ]]>
    </help>
    <expand macro="citations" />
</tool>