<tool id="cp319" name="Cellprofiler" version="@CP_VERSION@">
    <description>runs a CellProfiler pipeline assembled by all the CellProfiler tools upstream in the workflow</description>
    
    <macros>
        <import>macros.xml</import>
        <xml name="test_assert_content" token_n="291">
            <assert_contents>
                <has_n_lines n="@N@" />
            </assert_contents>
        </xml>
    </macros>

    <expand macro="requirements" version="@CP_VERSION@" package="cellprofiler" />
    <expand macro="stdio" />

    <command><![CDATA[
        bash '$script_file' &&
        cellprofiler -c -r --file-list list.txt -o ./output -p '$pipeline' 
    ]]></command>

    <configfiles>
        <configfile name="script_file">
mkdir ./input
mkdir ./output
#for $i,$filename in enumerate($inputdir):
    ln -s '$filename' ./input/${filename.element_identifier}.${filename.ext}
#end for

find `pwd`/input -name "*.*" > list.txt

        </configfile>
    </configfiles>
  
    <inputs>
        <param name="pipeline" type="data" format="txt" label="Pipeline file"/>
        <param name="inputdir" type="data" multiple="true" format="@FORMATS@" label="Images"/>
    </inputs>

    <outputs>
        <collection name="pipeline_output" type="list" label="Cellprofiler pipeline output files">
            <discover_datasets pattern="__designation_and_ext__" visible="false" directory="output"/>
        </collection>
    </outputs>

    <tests>
        <test>
            <param name="pipeline" value="ExampleHuman.cppipe" />
            <param name="inputdir" value="images/AS_09125_050116030001_D03f00d0.tif,images/AS_09125_050116030001_D03f00d1.tif,images/AS_09125_050116030001_D03f00d2.tif" />
            <output_collection name="pipeline_output" type="list">
                <element name="AS_09125_050116030001_D03f00d0.tif_Overlay">
                    <assert_contents>
                      <has_size value="183808"/>
                    </assert_contents>
                </element>
                <element name="Cells">
                    <expand macro="test_assert_content" n="290" />
                </element>
                <element name="Cytoplasm">
                  <expand macro="test_assert_content" n="290" />
                </element>
                <element name="Experiment">
                  <expand macro="test_assert_content" n="259" />
                </element>
                <element name="Image">
                  <expand macro="test_assert_content" n="2" />
                </element>
                <element name="Nuclei">
                  <expand macro="test_assert_content" n="290" />
                </element>
                <element name="PH3">
                  <expand macro="test_assert_content" n="21" />
                </element>
            </output_collection>
        </test>
    </tests>
    
    <help>
    This tool runs a complete Cellprofiler @CP_VERSION@ pipeline file. It takes a pipeline file and images from Galaxy history as input and generates its output files in Galaxy history. The input images can be a single zip file or multiple files.

    *** Parameters ***

    images: single zip file or multi-select image files
    
    pipeline: CellProfiler pipeline file(.cppipe) file.

    *** Note ***

    Only version @CP_VERSION@ pipeline can be run, other versions may cause problems.

    </help>

    <expand macro="citations" />
</tool>
