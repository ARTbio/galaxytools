<tool id="cp319" name="Cellprofiler" version="@GA_VERSION@">
  <description>Run a CellProfiler v3.1.9 pipeline</description>
  <expand macro="requirements" version="@CP_VERSION" package="cellprofiler" />
  <configfiles>
<configfile name="script_file">
mkdir `pwd`/input
mkdir `pwd`/output
#for $i,$filename in enumerate($inputType.inputdir):
ln -s $filename `pwd`/input/${filename.element_identifier}.${filename.ext}
#end for

find `pwd`/input -name *.tiff > list.txt

</configfile>
  </configfiles>

  <command><![CDATA[
      bash '$script_file' &&
      cellprofiler -c -r --file-list list.txt -o `pwd`/output -p $pipeline 
  ]]></command>
  <inputs>
	  <param name="pipeline" type="data" format="txt" label="Pipeline file"/>
    
    <conditional name="inputType">
       <param name="iType" type="select" label="Select either a zip file or a collection from history">
          <option value="c">collection</option>
          <option value="z">zip file</option>
          <option value="s">images</option>
       </param>
       <when value="z">
          <param name="inputdir" type="data" format="zip" label="Select image dataset from history" /> 
       </when>
        <when value="s">
          <param name="inputdir" type="data" multiple="true" format="tiff,tif" label="Images"/>
       </when>         
        <when value="c">
          <param name="inputdir" type="data_collection" collection_type="list" label="Images"/>
       </when>       
    </conditional>
          
  </inputs>
  <outputs>
   <!--  <data format="txt" name="out_file" />-->

      <collection name="pipeline_output" type="list" label="Cellprofiler pipeline output files">
        <discover_datasets pattern="__designation_and_ext__" visible="false" directory="output"/>
      </collection>     

  </outputs>

  <stdio>
  	<exit_code range="4:" level="fatal" description="Error occured"/>
  </stdio>

  <tests>

  </tests>
  <help>
    This tool runs a complete Cellprofiler v3.1.9 pipeline file. It takes a pipeline file and images from Galaxy history as input and generates its output files in Galaxy history. The input images can be a single zip file or multiple files.

    *** Parameters ***

    images: single zip file or multi-select image files
    
    pipeline: CellProfiler v3.1.9 pipeline file(.cppipe) file.

    *** Note ***

    Only version v3.1.9 pipeline can be run, other versions may cause problems.

  </help>
</tool>

